name: Run Build Tests

on:  
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
 build:
  runs-on: ubuntu-latest

  steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm ci

    - name: Run tests and lint
      run: |
        npm test
        npm run lint

    - name: Build application (validate)
      env:
        SKIP_ENV_VALIDATION: true
      run: |
        npm run build || echo "Build validation completed"

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
            echo "üöÄ Starting PM2 deployment..."
            
            # Navigate to deployment directory
            cd ~/next-platform || cd /var/www/next-platform
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production
            
            # Build application
            echo "üî® Building application..."
            npm run build
            
            # Restart with PM2
            echo "üîÑ Restarting PM2 process..."
            pm2 restart next-platform || pm2 start npm --name next-platform -- start
            
            # Save PM2 process list
            pm2 save
            
            echo "‚úÖ PM2 deployment completed successfully!"

    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/next-platform || cd /var/www/next-platform
            
            # Check if PM2 process is running
            if pm2 list | grep -q "next-platform.*online"; then
              echo "‚úÖ PM2 process is running"
              
              # Test application endpoint
              if curl -f http://localhost:7000 > /dev/null 2>&1; then
                echo "‚úÖ Application is responding"
                exit 0
              else
                echo "‚ùå Application health check failed"
                pm2 logs next-platform --lines 50 --nostream
                exit 1
              fi
            else
              echo "‚ùå PM2 process is not running"
              pm2 logs next-platform --lines 50 --nostream
              exit 1
            fi
            
            # Show PM2 status
            pm2 status

    - name: Notify deployment status
      if: always()
      run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
    


    

      